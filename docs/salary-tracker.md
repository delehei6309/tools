# 工资欠款计算器 - 需求文档

## 一、背景

公司从 2025年6月起拖欠工资，每月可能分多笔发放。需要一个工具追踪欠款情况。

## 二、数据模型

### 表1：月度应发表（只能创建/删除，不可修改）

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| 月份 | YYYY-MM | 是 | 唯一 |
| 应发金额 | 数值 | 是 | 单位：元 |
| 备注 | 文本 | 否 | 可选 |
| 创建时间 | ISO 8601 | 自动 | 记录创建时自动生成 |

### 表2：实发明细表

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| 到账日期 | YYYY-MM-DD | 是 | 实际到账日期 |
| 金额 | 数值 | 是 | 单位：元 |
| 归属月份 | YYYY-MM | 否 | 不填则自动按顺序补齐 |
| 备注 | 文本 | 否 | 可选 |
| 创建时间 | ISO 8601 | 自动 | 记录创建时自动生成 |
| 更新时间 | ISO 8601 | 自动 | 每次修改时自动更新 |

## 三、计算规则

1. **指定了归属月份**：直接冲抵对应月份
2. **未指定归属月份**：进入资金池，按月份顺序（从早到晚）自动补齐欠款
3. **月度欠款** = 应发 − 冲抵金额
4. **总欠款** = 所有月份欠款（正数）之和

## 四、计算示例

**输入：**
- 应发：2025-06: 12000，2025-07: 12000
- 实发：
  - 5000（未指定归属）
  - 8000（归属 2025-07）

**计算：**
1. 2025-06：应发 12000，指定 0，资金池补 5000 → 欠款 7000
2. 2025-07：应发 12000，指定 8000，资金池 0 → 欠款 4000

**结果：** 总欠款 11000

## 五、页面结构

```
┌───────────────────────────────────────────────┐
│  月度应发表                                    │
│  ┌──────────┬──────────┬────────┐             │
│  │ 月份     │ 应发金额  │ 操作   │             │
│  ├──────────┼──────────┼────────┤             │
│  │ 2025-06  │ 12000    │ 删除   │             │
│  │ 2025-07  │ 12000    │ 删除   │             │
│  └──────────┴──────────┴────────┘             │
│  [+ 添加月份]                                  │
├───────────────────────────────────────────────┤
│  实发明细表                                    │
│  ┌──────────┬────────┬──────────┬──────┬────┐ │
│  │ 到账日期  │ 金额   │ 归属月份  │ 备注 │操作│ │
│  ├──────────┼────────┼──────────┼──────┼────┤ │
│  │2025-08-10│ 5000   │   -      │      │删除│ │
│  │2025-09-05│ 8000   │ 2025-07  │      │删除│ │
│  └──────────┴────────┴──────────┴──────┴────┘ │
│  [+ 添加明细]                                  │
├───────────────────────────────────────────────┤
│  汇总                                          │
│  总应发：24000  总实发：13000  总欠款：11000    │
├───────────────────────────────────────────────┤
│  月度明细                                      │
│  ┌──────────┬────────┬────────┬────────┐      │
│  │ 月份     │ 应发   │ 已冲抵  │ 欠款   │      │
│  ├──────────┼────────┼────────┼────────┤      │
│  │ 2025-06  │ 12000  │ 5000   │ 7000   │      │
│  │ 2025-07  │ 12000  │ 8000   │ 4000   │      │
│  └──────────┴────────┴────────┴────────┘      │
└───────────────────────────────────────────────┘
```

## 六、交互需求

| 操作 | 说明 |
|------|------|
| 添加月份 | 选择月份 + 填写应发金额 + 备注（可选），创建后不可修改 |
| 添加明细 | 日期 + 金额 + 归属月份（可选）+ 备注 |
| 删除 | 点击即删 |
| 实时计算 | 数据变化时自动重新计算 |
| 本地存储 | 自动保存到 localStorage |
| 云同步 | 通过 GitHub Gist 实现多设备同步 |
| 金额脱敏 | 一键隐藏/显示所有金额 |

### 6.1 金额脱敏功能

#### 功能说明

在页面右上角提供一个「眼睛」图标按钮，点击可切换金额的显示/隐藏状态。

#### 脱敏效果

| 状态 | 显示效果 |
|------|---------|
| 显示 | 12000 |
| 隐藏 | **** |

#### 脱敏范围

- 月度应发表：应发金额
- 实发明细表：金额
- 汇总区域：总应发、总实发、总欠款
- 月度明细表：应发、已冲抵、欠款

#### 交互设计

```
┌─────────────────────────────────────────────┐
│  工资欠款计算器            [👁] [退出登录]   │
├─────────────────────────────────────────────┤
│  ...                                        │
```

- 👁（眼睛睁开）：金额正常显示
- 👁‍🗨（眼睛闭上）：金额显示为 ****
- 状态保存到 localStorage，刷新后保持

## 七、访问验证

### 7.1 验证方式

使用 GitHub Token 作为访问凭证，未配置有效 Token 时无法查看和操作数据。

### 7.2 验证流程

```
┌─────────────────────────────────────────┐
│  访问页面                                │
│         ↓                               │
│  检查 localStorage 是否有 Token          │
│         ↓                               │
│  ┌─────────────────────────────────┐    │
│  │ 无 Token 或 Token 无效           │    │
│  │ → 显示登录页面（输入 Token）      │    │
│  └─────────────────────────────────┘    │
│         ↓                               │
│  ┌─────────────────────────────────┐    │
│  │ Token 有效                       │    │
│  │ → 进入主页面，加载数据            │    │
│  └─────────────────────────────────┘    │
└─────────────────────────────────────────┘
```

### 7.3 验证逻辑

1. 页面加载时检查 localStorage 中是否存在 Token
2. 若存在，调用 GitHub API 验证 Token 有效性
3. 验证通过后显示主界面，否则显示登录界面
4. 登录界面只有一个输入框（Token）和登录按钮

### 7.4 登录界面

```
┌─────────────────────────────────────────┐
│                                         │
│         工资欠款计算器                   │
│                                         │
│    ┌─────────────────────────────┐      │
│    │ 请输入 GitHub Token          │      │
│    └─────────────────────────────┘      │
│                                         │
│           [ 登录 ]                      │
│                                         │
│    Token 获取方式：                      │
│    GitHub → Settings → Developer        │
│    settings → Personal access tokens    │
│                                         │
└─────────────────────────────────────────┘
```

### 7.5 安全说明

- Token 仅存储在本地浏览器，不经过任何第三方服务器
- 验证通过 GitHub 官方 API 进行
- 退出登录时清除本地 Token
- 页面支持「退出登录」操作

## 八、云同步方案（GitHub Gist）

### 8.1 方案说明

使用 GitHub Gist 作为云端存储，实现多设备数据同步，无需自建服务器。

### 8.2 工作流程

1. 用户在 GitHub 生成 Personal Access Token（仅需 `gist` 权限）
2. 在页面设置中填入 Token，保存到 localStorage
3. 首次同步时自动创建私有 Gist 存储数据
4. 后续修改自动/手动同步到 Gist

### 8.3 Token 配置步骤

1. 访问 GitHub → Settings → Developer settings → Personal access tokens → Tokens (classic)
2. 点击 Generate new token (classic)
3. 勾选 `gist` 权限（仅需此项）
4. Expiration 选择 **No expiration**（永不过期）
5. 生成后复制保存（只显示一次）

### 8.4 页面功能

| 功能 | 说明 |
|------|------|
| Token 配置 | 设置弹窗，输入并保存 GitHub Token |
| 上传同步 | 将本地数据同步到云端 Gist |
| 下载同步 | 从云端 Gist 拉取数据覆盖本地 |
| 同步状态 | 显示上次同步时间、Gist ID |

### 8.5 数据结构

Gist 中存储的 JSON 格式：

```json
{
  "version": 1,
  "updatedAt": "2026-01-08T12:00:00Z",
  "monthlyDue": [
    {
      "month": "2025-06",
      "amount": 12000,
      "note": "",
      "createdAt": "2026-01-08T10:00:00Z"
    }
  ],
  "payments": [
    {
      "date": "2025-08-10",
      "amount": 5000,
      "targetMonth": null,
      "note": "",
      "createdAt": "2026-01-08T10:30:00Z",
      "updatedAt": "2026-01-08T10:30:00Z"
    }
  ]
}
```

### 8.6 安全说明

- Token 仅授予 `gist` 权限，不影响代码仓库
- Token 存储在浏览器 localStorage，不上传到任何服务器
- Gist 默认创建为私有，仅自己可见
- 可随时在 GitHub 撤销 Token 并重新生成

## 九、校验规则

- 月份不可重复
- 金额必须 ≥ 0
- 日期格式校验
- 若填写归属月份，必须是已录入的月份

## 十、验收标准

1. ✅ 归属月份可填可不填
2. ✅ 未指定归属的自动按顺序补齐
3. ✅ 计算正确
4. ✅ 数据持久化（localStorage）
5. ✅ 可添加/删除月度应发和实发明细
6. ✅ 输入校验完善
7. ✅ 支持 GitHub Gist 云同步
8. ✅ Token 配置与状态显示正常
9. ✅ 未登录时无法查看/操作数据
10. ✅ 支持退出登录
11. ✅ 支持一键金额脱敏/显示
12. ✅ 脱敏状态刷新后保持
